var LeafFormQuery=function(){var i={},e=null,a="",r=!1;function t(){i={terms:[],joins:[],sort:{},getData:[]}}function n(t,e,a){var r={};r.id=t,r.operator=e,r.match=a,i.terms.push(r)}function o(t,e,a,r){var n={};n.id=t,n.indicatorID=e,n.operator=a,n.match=r,i.terms.push(n)}function d(t){i.limitOffset=t}function s(t){-1==i.joins.indexOf(t)&&i.joins.push(t)}function l(t){-1==i.getData.indexOf(t)&&i.getData.push(t)}return t(),{clearTerms:t,addTerm:n,addDataTerm:o,importQuery:function(t){for(var e in t.terms)switch(Object.keys(t.terms[e]).length){case 3:n(t.terms[e].id,t.terms[e].operator,t.terms[e].match);break;case 4:o(t.terms[e].id,t.terms[e].indicatorID,t.terms[e].operator,t.terms[e].match);break;default:console.log("Format error")}for(var e in t.joins)s(t.joins[e]);for(var e in t.getData)l(t.getData[e])},getQuery:function(){return i},getData:l,updateTerm:function(t,e,a){for(var r in i.terms)if(i.terms[r].id==t&&i.terms[r].operator==e)return void(i.terms[r].match=a);n(t,e,a)},updateDataTerm:function(t,e,a,r){for(var n in i.terms)if(i.terms[n].id==t&&i.terms[n].indicatorID==e&&i.terms[n].operator==a)return void(i.terms[n].match=r);o(t,e,a,r)},setQuery:function(t){i=t},setLimit:function(t,e){void 0===e?i.limit=t:(i.limit=e,d(t))},setLimitOffset:d,setRootURL:function(t){a=t},getRootURL:function(){return a},useJSONP:function(t){r=t},join:s,sort:function(t,e){i.sort.column=t,i.sort.direction=e},onSuccess:function(t){e=t},execute:function(){return null!=i.getData&&0==i.getData.length&&delete i.getData,0==r?$.ajax({type:"GET",url:a+"api/?a=form/query&q="+JSON.stringify(i),dataType:"json",success:e,cache:!1}):$.ajax({type:"GET",url:a+"api/?a=form/query&q="+JSON.stringify(i)+"&format=jsonp",dataType:"jsonp",success:e,cache:!1})}}},LeafFormGrid=function(s,t){s=s;var u,f,h="LeafFormGrid"+Math.floor(1e3*Math.random())+"_",p=!0,m=[],D=0,l=!1,b=50,g=50,c="#d1dfff",y={},i=null,v=null,I=null,_="",x=!0,k=!1;$("#"+s).html('<div id="'+h+'grid"></div><div id="'+h+'form" style="display: none"></div>'),$("#"+h+"grid").html('<div style="position: relative"><div id="'+h+'gridToolbar" style="display: none; width: 90px; margin: 0 0 0 auto; text-align: right"></div></div><div id="'+h+'table_stickyHeader" style="display: none"></div><table id="'+h+'table" class="leaf_grid"><thead id="'+h+'thead" aria-label="Search Results"></thead><tbody id="'+h+'tbody"></tbody><tfoot id="'+h+'tfoot"></tfoot></table>'),$("#"+h+"thead").css({"background-color":c}),null==t&&(u=new LeafForm(h+"form"));var w=0;function N(a,t){"recordID"!=a&&g!=1/0&&L(0,1/0),$("."+h+"sort").css("display","none"),"asc"==t.toLowerCase()?($("#"+h+"header_"+a+"_sort").html(" &#9650;"),$("#"+h+"header_"+a+"_sort").css("vertical-align","super")):($("#"+h+"header_"+a+"_sort").html(" &#9660;"),$("#"+h+"header_"+a+"_sort").css("vertical-align","sub")),$("#"+h+"header_"+a+"_sort").css("display","inline");var e,r=[],n=$.isNumeric(a),i=!1,o="id"+a;for(var d in m)m[d].recordID=parseInt(m[d].recordID),null==m[d][a]&&(m[d][a]=$("#"+h+m[d].recordID+"_"+a).html(),m[d][a]=null==m[d][a]?"":m[d][a],m[d][a]=m[d][a].replace(/[\u200B-\u200E]/g,"")),n?(null==m[d].s1&&(m[d].s1={}),null!=m[d].s1[o]&&""!=m[d].s1[o]||(null==m[d].sDate&&(m[d].sDate={}),m[d].s1[o]="",m[d].sDate[a]=0),e=null,!isNaN(m[d].s1[o])||-1==m[d].s1[o].indexOf("-")&&-1==m[d].s1[o].indexOf("/")||(e=Date.parse(m[d].s1[o])),(i||null!=e&&!isNaN(e))&&(i=!0,null==m[d].sDate&&(m[d].sDate={}),m[d].sDate[a]=0,m[d].sDate[a]=isNaN(e)?0:e),$.isNumeric(m[d].s1[o])&&(m[d].s1[o]=parseFloat(m[d].s1[o]))):((e=null)==m[d].sDate&&(m[d].sDate={}),m[d].sDate[a]=0,!isNaN(m[d][a])||-1==m[d][a].indexOf("-")&&-1==m[d][a].indexOf("/")||(e=Date.parse(m[d][a])),(i||null!=e&&!isNaN(e))&&(i=!0,m[d].sDate[a]=isNaN(e)||null==e?0:e)),r.push(m[d]);i?r.sort(function(t,e){return e.sDate[a]>t.sDate[a]?1:e.sDate[a]<t.sDate[a]?-1:0}):$.isNumeric(a)?r.sort(function(t,e){return e.s1[o]>t.s1[o]?1:e.s1[o]<t.s1[o]?-1:0}):"recordID"==a?r.sort(function(t,e){return e[a]>t[a]?1:e[a]<t[a]?-1:0}):r.sort(function(t,e){return null==t[a]&&(t[a]=""),null==e[a]&&(e[a]=""),e[a].toLowerCase()>t[a].toLowerCase()?1:e[a].toLowerCase()<t[a].toLowerCase()?-1:0}),"asc"==t&&r.reverse(),m=r}function T(){if(!x)return!1;var e=[];$("#"+h+"thead>tr>th").each(function(){e.push($(this).css("width"))}),$("#"+h+"table_stickyHeader > table").css({width:$("#"+h+"thead").css("width"),height:"30px"}),$("#"+h+"table_stickyHeader > table > thead > tr > th").each(function(t){$(this).css({width:e[t],padding:"2px","font-weight":"normal"})}),$("#"+h+"table_stickyHeader > table").css({border:"1px solid black","border-collapse":"collapse",margin:"0 2px 0"}),$("#"+h+"table_stickyHeader > table > thead > tr").css({"background-color":"black",color:"white"}),$("#"+h+"table_stickyHeader > table > thead > tr > th").css("border","1px solid #e0e0e0")}function L(t,e){k=!0,null!=v&&v(),null==e&&(e=b),g=e;var a=!1;null!=t&&0!=t||(t=0,$("#"+h+"tbody").empty(),a=!0);var r="",n=[],i=p?f.length+1:f.length;0==m.length&&$("#"+h+"tbody").append('<tr><td colspan="'+i+'" style="text-align: center">No Results</td></tr>');for(var o=0,d=t;d<m.length;d++){if(e<=o){D=d;break}for(var s in r+='<tr id="'+h+"tbody_tr"+m[d].recordID+'">',p&&(r+='<td><a href="index.php?a=printview&recordID='+m[d].recordID+'">'+m[d].recordID+"</a></td>"),f)if(0!=f[s].visible)if(null!=m[d]){var l={};l.recordID=m[d].recordID,l.indicatorID=f[s].indicatorID,l.cellContainerID=h+m[d].recordID+"_"+f[s].indicatorID,l.index=d,l.data="";var c=!1;null!=f[s].editable&&0==f[s].editable||(c=!0),$.isNumeric(l.indicatorID)?(null==m[d].s1&&(m[d].s1={}),l.data=null!=m[d].s1["id"+f[s].indicatorID]?m[d].s1["id"+f[s].indicatorID]:"",r+='<td id="'+h+m[d].recordID+"_"+f[s].indicatorID+'" data-editable="'+c+'" data-record-id="'+m[d].recordID+'" data-indicator-id="'+f[s].indicatorID+'">'+l.data+"</td>"):null!=f[s].callback?r+='<td id="'+h+m[d].recordID+"_"+f[s].indicatorID+'" data-clickable="'+c+'"></td>':r+='<td id="'+h+m[d].recordID+"_"+f[s].indicatorID+'"></td>',null!=f[s].callback&&n.push(function(t,e){return function(){t(e,y)}}(f[s].callback,l))}else r+='<td id="'+h+m[d].recordID+"_"+f[s].indicatorID+'"></td>';r+="</tr>",o++,a&&(D=d+1)}for(var d in D+e>=m.length||null==e?$("#"+h+"tfoot").html(""):$("#"+h+"tfoot").html("<tr><td colspan="+i+' style="padding: 8px; background-color: #feffd1; font-size: 120%; font-weight: bold"><img src="'+_+'images/indicator.gif" style="vertical-align: middle" alt="Loading" /> Loading more results...</td></tr>'),$("#"+h+"tbody").append(r),$("#"+h+"tbody td[data-editable=true]").addClass("table_editable"),$("#"+h+"tbody td[data-clickable=true]").addClass("table_editable"),$("#"+h+"tbody").on("click","td[data-editable=true]",function(t){u.setRecordID($(this).data("record-id"));var e=$(this).data("indicator-id");u.setPostModifyCallback(function(){var n,t;n=e,t=1,$.ajax({type:"GET",url:_+"api/?a=form/"+recordID+"/rawIndicator/"+n+"/"+t,dataType:"json",success:function(t){var e=""!=t[n].displayedValue?t[n].displayedValue:t[n].value;if("checkboxes"==t[n].format&&Array.isArray(e)){var a="";for(var r in e)"no"!=e[r]&&(a+=", "+e[r]);e=a.substr(2)}$("#"+h+recordID+"_"+n).empty().html(e),$("#"+h+recordID+"_"+n).fadeOut(250,function(){$("#"+h+recordID+"_"+n).fadeIn(250)})},cache:!1}),u.dialog().hide()}),u.getForm(e,1),u.dialog().show()}),n)n[d]();$("#"+h+"table>tbody>tr>td").css({border:"1px solid black",padding:"8px","font-size":"12px"}),null!=I&&I(),T()}function r(t){l=!0,m=t}function n(t){y=t}return{getPrefixID:function(){return h},form:function(){return u},headers:function(){return f},getCurrentData:function(){return m},hideIndex:function(){p=!1},setHeaders:function(t){f=t;var e='<tr id="'+h+'thead_tr">',a='<tr id="'+h+'tVirt_tr">';for(var r in p&&(e+='<th id="'+h+'header_UID" style="text-align: center">UID</th>',a+='<th style="text-align: center">UID</th>'),$("#"+h+"thead").html(e),p&&($("#"+h+"header_UID").css("cursor","pointer"),$("#"+h+"header_UID").on("click",null,null,function(t){w=0==w?(N("recordID","asc"),1):(N("recordID","desc"),0),L(0,1/0)}),$("#"+h+"header_UID").on("mouseover",null,null,function(t){$("#"+h+"header_UID").css("background-color","#79a2ff")}),$("#"+h+"header_UID").on("mouseout",null,null,function(t){$("#"+h+"header_UID").css({"background-color":c})})),f)if(0!=f[r].visible){var n=null!=f[r].align?f[r].align:"center";$("#"+h+"thead_tr").append('<th id="'+h+"header_"+f[r].indicatorID+'" tabindex="0"  style="text-align:'+n+'">'+f[r].name+'<span id="'+h+"header_"+f[r].indicatorID+'_sort" class="'+h+'sort"></span></th>'),a+='<th id="Vheader_'+f[r].indicatorID+'" style="text-align:'+n+'">'+f[r].name+"</th>",null!=f[r].sortable&&1!=f[r].sortable||($("#"+h+"header_"+f[r].indicatorID).css("cursor","pointer"),$("#"+h+"header_"+f[r].indicatorID).on("click",null,f[r].indicatorID,function(t){w=0==w?(N(t.data,"asc"),1):(N(t.data,"desc"),0),L(0,1/0)}),$("#"+h+"header_"+f[r].indicatorID).on("keydown",null,f[r].indicatorID,function(t){13==t.keyCode&&(w=0==w?(N(t.data,"asc"),1):(N(t.data,"desc"),0),L(0,1/0))}),$("#"+h+"header_"+f[r].indicatorID).on("mouseover",null,f[r].indicatorID,function(t){$("#"+h+"header_"+t.data).css("background-color","#79a2ff")}),$("#"+h+"header_"+f[r].indicatorID).on("mouseout",null,f[r].indicatorID,function(t){$("#"+h+"header_"+t.data).css({"background-color":c})}))}$("#"+h+"thead").append("</tr>"),a+="</tr>",$("#"+h+"table>thead>tr>th").css({border:"1px solid black",padding:"4px 2px 4px 2px","font-size":"12px"});var i,o=!1;$("#"+h+"table_stickyHeader").html("<table><thead>"+a+"</thead></table>"),$(window).on("resize",function(){T()}),$(window).on("scroll",function(){o=!0});var d=[];setInterval(function(){scrollPos=$(window).scrollTop(),tableHeight=$("#"+h+"table").height(),pageHeight=$(window).height(),o&&null!=$("#"+h+"thead").offset()&&x&&(o=!1,i=$("#"+h+"thead").offset().top,scrollPos>i&&scrollPos<tableHeight+i?($("#"+h+"table_stickyHeader").css("display","inline"),$("#"+h+"table_stickyHeader").css({position:"absolute",top:scrollPos+"px"})):$("#"+h+"table_stickyHeader").css("display","none")),scrollPos>tableHeight-.8*pageHeight&&l&&k&&null==d[D]&&(d[D]=1,L(D,b))},100)},sort:N,renderVirtualHeader:T,renderBody:L,loadData:function(t,n){m=[];var e=p?f.length+1:f.length;$("#"+h+"tbody").html('<tr><td colspan="'+e+'" style="text-align: left; padding: 8px">Building report... <img src="'+_+'images/largespinner.gif" alt="loading..." /></td></tr>');var a="";for(var r in f)$.isNumeric(f[r].indicatorID)&&(a+=f[r].indicatorID+",");$.ajax({type:"POST",url:_+"api/?a=form/customData",dataType:"json",data:{recordList:t,indicatorList:a,CSRFToken:CSRFToken},success:function(t){for(var e in l=!0,t){if(null!=y[e])for(var a in y[e])if("object"==typeof y[e][a])for(var r in y[e][a])t[e][a]=t[e][a]||{},t[e][a][r]=y[e][a][r];else t[e][a]=y[e][a];m.push(t[e])}null!=i&&(m=i(m)),N("recordID","desc"),L(0,b),null!=n&&"function"==typeof n&&n()},cache:!1})},setData:r,setDataBlob:n,importQueryResult:function(t){var e=[];for(var a in t)e.push(t[a]);r(e),n(e)},enableToolbar:function(){s=h+"gridToolbar",$("#"+s).css("display","block"),$("#"+s).html('<button type="button" id="'+h+'getExcel" class="buttonNorm"><img src="../libs/dynicons/?img=x-office-spreadsheet.svg&w=32" alt="Icon of Spreadsheet" /> Export</button>'),$("#"+h+"getExcel").on("click",function(){D!=m.length&&L(0,1/0);var a=[],r=[];$("#"+h+"thead>tr>th").each(function(t,e){r.push($(e).text().trim())});var n={},i=0,o=(document.createElement("a"),r.length-1);$("#"+h+"tbody>tr>td").each(function(t,e){n[r[i]]=$(e).text().trim(),0==i&&"UID"==r[i]&&(n[r[i]]='=HYPERLINK("'+window.location.origin+window.location.pathname+"?a=printview&recordID="+$(e).text().trim()+'", "'+$(e).text().trim()+'")'),o<++i&&(a.push(n),n={},i=0)});var t=$(document.createElement("form"));t.attr({action:_+"api/?a=converter/json&format=csv",method:"POST"});var e=$(document.createElement("input")),d=$(document.createElement("input"));e.attr({type:"hidden",name:"input",value:JSON.stringify(a)}),d.attr({type:"hidden",name:"CSRFToken",value:CSRFToken}),t.append(e),t.append(d),t.appendTo("#"+s),t.submit(),t.remove()})},setPostProcessDataFunc:function(t){i=t},setPreRenderFunc:function(t){v=t},setPostRenderFunc:function(t){I=t},setDefaultLimit:function(t){b=t},getDefaultLimit:function(){return b},getDataByIndex:function(t){return m[t]},getDataByRecordID:function(t){for(var e in m)if(m[e].recordID==t)return m[e];return null},disableVirtualHeader:function(){x=!1},stop:function(){k=!1},setRootURL:function(t){_=t}}};